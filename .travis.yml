dist: xenial
language: python
python:
- 3.6
git:
  depth: false
addons:
  apt:
    sources:
    - sourceline: ppa:tah83/secp256k1
    packages:
    - libsecp256k1-0
before_install:
- git tag
install:
- pip install -r contrib/requirements/requirements-travis.txt
cache:
- pip: true
- directories:
  - "/tmp/electrum-build"
script:
- tox
after_success:
- if [ "$TRAVIS_BRANCH" = "master" ]; then pip install requests && contrib/push_locale;
  fi
- coveralls
jobs:
  include:
  - name: Flake8 linter tests
    language: python
    install: pip install flake8
    script: flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
  - if: branch = bixin_dev
    name: Native Android build
    services:
    - docker
    install:
    - while sleep 60; do echo "=====[ $SECONDS seconds still running ]====="; done
      &
    - sudo docker pull lightningcn/electrum_env:latest
    script:
    - while sleep 60; do echo "=====[ $SECONDS seconds still running ]====="; done
      &
    - sudo docker run --rm -it --name electrum-android-native-builder-cont -v $PWD:/data
      --workdir=/data/android lightningcn/electrum_env:latest /bin/bash -c "cp ~/android/local.properties
      local.properties && /data/android/gradlew app:build"
    - kill %1
    - ls -la android/app/build/outputs/apk/MainNet/release/
    - if [ $(ls android/app/build/outputs/apk/MainNet/release/ | grep -c bixin-*)
      -eq 0 ]; then exit 1; fi
    after_success: true

deploy:
  provider: releases
  api_key:
    secure: ysfbMMqf2qDlHdagqzdIOoeiNCcaJ/dw8DhSsFjhbyV7YXZjTkYh4b36iWmq7WHAgJRukdNrdGdktf/kksOlAo4MsX0sdGipOsRCheiHYQNgeH8BOdOrs7UwjXiqQL3/AkzfAHbjdvhUNHDZVtZsCh2Eay8etioiYdwutcqTzi7Rqq+tXaklWXsFLo23+FAU/bX39NDUmhUbehCR4xr76jNXpMYqOniYfylOikgq2zlR3gQ693zviNWTs9O3jEDnxYk9337rL69Xm0viBRJODqC7wX91orBAZ58+ZnGzoELSH+n2EFS8YgIg8hrWSoyZqa44N/92ypPzykVLLmCv353zo3MalE+tCmWVHTjG6LOfu4PldrAg+Y9rmW7ov/UDs3jM2gLiMR9tE0E6wOVsfDlUw9wxfmsUdR7JZSqOYW9y41G2uUqQR9mnuu7Wdn0lvfmvBe8o8byoPflsiPNM5AEyLkv3EcGxgu5C8/owgUW+DA4RxGGwPQxOl0AQGm5pBAbrAj4Q3mgT/HkMaokv05cACeXyz6rL7yYUU2BWKAKtBoIIHL1ICR9Ub6siblvkuJwM259PmHrDkRPI6Swg5nEqE6ZbAA9qPsHCGGKdtTSLUBVD4JZsNBRiiYaRHrkpCNXxU58POj1xLBm/F6L3l2WkU4g3ogIitjCx7hZCJmI=
  file:
    - "android/app/build/outputs/apk/RegTest/release/bixin-4.0.0-0.apk"
  skip_cleanup: true
  overwrite: true
  on:
    branch: bixin_test 
